<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AstroKid Badge Creator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: white;
      overflow-y: auto;
      touch-action: auto;
    }
    .main-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px;
      min-height: 100vh;
      overflow-y: auto;
      touch-action: auto;
    }
    .top-buttons {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      max-width: 772.98px;
    }
    .top-buttons a.button,
    .top-buttons .upload-container {
      width: 376.49px;
      margin: 0;
      touch-action: none;
    }
    .canvas-and-controls {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      width: 100%;
      justify-content: center;
      gap: 20px;
    }
    #canvas-container {
      width: 491px;
      height: 310px;
      max-width: 100%;
      background-image: url('https://raw.githubusercontent.com/awesem0/Astro/main/11112015-AstroKidBadge.png');
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      flex-shrink: 0;
      margin-left: 0px;
      background-color: white;
      touch-action: manipulation;
      aspect-ratio: 491 / 310;
    }
    .main-container.portrait #canvas-container {
      width: 387px;
      height: 614px;
      max-width: 100%;
      aspect-ratio: 387 / 614;
    }
    canvas {
      width: 100%;
      height: 100%;
      background-color: transparent;
      display: block;
    }
    .controls {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      flex-grow: 1;
      max-width: 370.82px;
    }
    .main-container:not(.portrait) .controls {
      margin-top: 0;
    }
    .photo-controls {
      display: flex;
      flex-direction: column;
      width: 370.82px;
    }
    .download-section {
      margin-top: 10px;
      width: 370.82px;
    }
    .main-container.portrait .download-section {
      margin-top: 10px;
    }
    .download-section button {
      width: 100%;
      height: 66px;
      touch-action: none;
      background-color: #0066CC;
    }
    .download-section button:active {
      background-color: #4D8CFF;
    }
    .slider-container {
      display: flex;
      align-items: center;
      margin: 10px 0;
      width: 370.82px;
    }
    .slider-container label {
      width: 90px;
      text-align: left;
      font-size: 16px;
    }
    .slider-container input[type="range"] {
      flex: 1;
      height: 20px;
      touch-action: pan-x;
      width: 100%;
    }
    .text-input-container {
      display: flex;
      flex-direction: column;
      margin: 10px 0;
      width: 370.82px;
    }
    .text-input-container input[type="text"] {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      border: 2px solid #000000;
      border-radius: 5px;
      box-sizing: border-box;
      height: 40px;
    }
    button, a.button, label.upload-button {
      margin: 0;
      cursor: pointer;
      background-color: #0066CC;
      color: white;
      border: 3px solid #0066CC;
      border-radius: 8px;
      height: 66px;
      text-align: center;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      font-size: 16px;
      font-weight: bold;
    }
    button:hover, a.button:hover, label.upload-button:hover {
      background-color: #004d99;
    }
    .hidden {
      display: none;
    }
    .download-container {
      margin: 0;
      width: 100%;
    }
    .upload-container {
      position: relative;
    }
    .upload-container input[type="file"] {
      display: none;
    }
    .layer-buttons {
      display: flex;
      flex-direction: row;
      gap: 5px;
      margin: 10px 0;
      width: 370.82px;
    }
    .layer-buttons button {
      width: 182.91px;
      padding: 0;
      margin: 0;
      height: 66px;
    }
    #loading-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
    .disclaimer {
      text-align: center;
      font-size: 14px;
      margin-bottom: 10px;
      max-width: 772.98px;
    }
    .video-tutorial {
      margin: 20px 0;
      text-align: center;
      max-width: 902.9px;
      width: 100%;
      position: relative;
    }
    .video-tutorial iframe {
      max-width: 100%;
      width: 100%;
      height: auto;
      aspect-ratio: 16 / 9;
    }
    @media (max-width: 740px) {
      .main-container {
        align-items: center;
        min-height: auto;
      }
      .top-buttons {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        width: 100%;
        max-width: 100%;
      }
      .top-buttons a.button,
      .top-buttons .upload-container {
        width: calc(45% + 3.78px);
        box-sizing: border-box;
        height: 35px;
      }
      a.button, label.upload-button {
        height: 35px;
        font-size: 10px;
        padding: 0 8px;
      }
      .canvas-and-controls {
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      #canvas-container {
        width: 100%;
        max-width: 100%;
        height: auto;
        margin-bottom: 0;
        margin-left: 0;
      }
      .main-container.portrait #canvas-container {
        width: 100%;
        max-width: 100%;
        height: auto;
        margin-bottom: 0;
      }
      .controls {
        align-items: center;
        max-width: 100%;
        width: 100%;
      }
      .main-container:not(.portrait) .controls {
        margin-top: 0;
      }
      .photo-controls {
        width: 100%;
        max-width: 100%;
      }
      .download-section {
        width: 100%;
        max-width: 100%;
        margin-top: 10px;
        margin-bottom: 3.2px;
      }
      .download-section button {
        height: 35px;
        font-size: 12px;
        width: 100%;
      }
      .slider-container {
        width: 100%;
      }
      .slider-container input[type="range"] {
        height: 20px;
        width: 100%;
      }
      .text-input-container {
        width: 100%;
        margin: 5px 0;
      }
      .text-input-container input[type="text"] {
        font-size: 12px;
        padding: 6px;
        height: 30px;
      }
      .layer-buttons {
        width: 100%;
        margin: 3.2px 0;
      }
      .layer-buttons button {
        width: 50%;
        height: 35px;
        font-size: 10px;
      }
      .disclaimer {
        font-size: 12px;
      }
      .video-tutorial iframe {
        width: 100%;
        height: auto;
        max-width: 100%;
        aspect-ratio: 16 / 9;
      }
    }
    @media (max-width: 772.98px) and (min-width: 741px) {
      .top-buttons {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="disclaimer">
      This is a fictional graphic tool for fun only. No data is stored.
    </div>
    <div class="top-buttons">
      <a href="https://www.etsy.com/uk/listing/1815856491/personalised-astronaut-9-printable" target="_blank" class="button">BUY TEMPLATE</a>
      <a href="https://www.pixelcut.ai/t/background-remover" target="_blank" class="button">REMOVE PHOTO BACKGROUND</a>
      <div class="upload-container">
        <label for="templateUpload" class="upload-button">UPLOAD TEMPLATE</label>
        <input type="file" id="templateUpload" accept="image/*" multiple>
      </div>
      <div class="upload-container">
        <label for="photoUpload" class="upload-button">UPLOAD PHOTO</label>
        <input type="file" id="photoUpload" accept="image/*">
      </div>
    </div>
    <div class="canvas-and-controls">
      <div id="canvas-container">
        <div id="loading-message">Loading...</div>
      </div>
      <div class="controls">
        <div class="photo-controls">
          <div id="photo-sliders" class="hidden">
            <div class="slider-container">
              <label for="scale">Scale: </label>
              <input type="range" id="scale" min="0.1" max="2" step="0.01" value="1.25" />
            </div>
            <div class="slider-container">
              <label for="xPos">Left Right: </label>
              <input type="range" id="xPos" min="-307" max="307" value="56.69" />
            </div>
            <div class="slider-container">
              <label for="yPos">Up Down: </label>
              <input type="range" id="yPos" min="-193.5" max="193.5" value="-18.9" />
            </div>
            <div class="slider-container">
              <label for="rotation">Rotation: </label>
              <input type="range" id="rotation" min="-22" max="22" step="0.1" value="0" />
            </div>
            <div class="layer-buttons">
              <button id="sendBack">SEND TO BACK</button>
              <button id="bringFront">BRING TO FRONT</button>
            </div>
            <div class="text-input-container">
              <input type="text" id="height" placeholder="Enter height" />
            </div>
            <div class="text-input-container">
              <input type="text" id="width" placeholder="Enter width" />
            </div>
          </div>
          <div class="download-section">
            <div class="download-container">
              <button id="download">DOWNLOAD</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="video-tutorial">
      <iframe width="720" height="405" src="https://www.youtube.com/embed/gttgUO5cl9k?si=hf60qIbFZXinuQ6N&vq=hd720" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
    </div>
  </div>
  <script>
    let templateImg, photoImg;
    let xPos = 56.69, yPos = -18.9, scaleVal = 1.25, rotationVal = 0;
    let photoInFront = true;
    let templateLoaded = false, photoLoaded = false;
    let photoAspectRatio = 1;
    let canvasWidth = 491, canvasHeight = 310;
    let isPortrait = false;
    let height = "";
    let width = "";
    let isDragging = false;
    let dragStartX, dragStartY;
    let isPinching = false;
    let initialPinchDistance = 0;
    let initialScale = 0;
    let originalTemplateWidth, originalTemplateHeight;
    const loadingMessage = document.getElementById('loading-message');
    let canvas;
    let heightPosX = 49.44, heightPosY = 230.66 - 11.81 + 5.905 + 1.181 + 2.362, heightFontSize = 25;
    let widthPosX = 57, widthPosY = 272 - 11.81 + 7.086 + 1.181;
    const maxNameWidth = 300;
    function setup() {
      canvas = createCanvas(canvasWidth, canvasHeight);
      pixelDensity(2);
      canvas.parent('canvas-container');
      background(0, 0, 0, 0);
      document.querySelector('#photo-sliders').classList.add('hidden');
      document.querySelector('.download-section').classList.add('hidden');
      textFont('Orbitron', 'Arial');
      updateCanvasSize();
    }
    function updateCanvasSize() {
      const container = document.getElementById('canvas-container');
      const containerWidth = container.offsetWidth;
      canvasWidth = containerWidth;
      canvasHeight = isPortrait ? containerWidth * (1010 / 638) : containerWidth * (638 / 1016);
      resizeCanvas(canvasWidth, canvasHeight);
      if (!isPortrait) {
        yPos = -94.5;
      } else {
        yPos = -18.9;
      }
      document.getElementById('yPos').value = yPos;
      if (photoLoaded) {
        document.querySelector('#photo-sliders').classList.remove('hidden');
        document.querySelector('.download-section').classList.remove('hidden');
      } else {
        document.querySelector('#photo-sliders').classList.add('hidden');
        document.querySelector('.download-section').classList.add('hidden');
      }
      updateSliderRanges();
      updateTextPositions();
    }
    function updateSliderRanges() {
      const xMax = canvasWidth / 2;
      const yMax = canvasHeight / 2;
      document.getElementById('xPos').setAttribute('min', -xMax);
      document.getElementById('xPos').setAttribute('max', xMax);
      document.getElementById('yPos').setAttribute('min', -yMax);
      document.getElementById('yPos').setAttribute('max', yMax);
    }
    function updateTextPositions() {
      if (isPortrait) {
        heightPosX = 117.66;
        heightPosY = 416.89 - 11.81 + 7.086;
        widthPosX = 117.66;
        widthPosY = 446.89 - 11.81 + 7.086 - 1.181 - 1.181;
      } else {
        heightPosX = 49.44;
        heightPosY = 230.66 - 11.81 + 5.905 + 1.181 + 2.362;
        widthPosX = 57;
        widthPosY = 272 - 11.81 + 7.086 + 1.181;
      }
    }
    function adjustFontSizeForName(text, initialFontSize, maxWidth, isHeight = false) {
      textFont('Orbitron', 'Arial');
      let fontSize = initialFontSize;
      if (isHeight && text.length > 9) {
        fontSize = initialFontSize * (9 / text.length);
      }
      textSize(fontSize);
      let textWidth = window.textWidth(text);
      while (textWidth > maxWidth && fontSize > 10) {
        fontSize -= 1;
        textSize(fontSize);
        textWidth = window.textWidth(text);
      }
      return fontSize;
    }
    function isTouchOverPhoto(x, y) {
      if (!photoLoaded || !photoImg) return false;
      if (!isPortrait) {
        return x >= 0 && x <= canvasWidth && y >= 0 && y <= canvasHeight;
      } else {
        let scaledHeight = photoImg.height * scaleVal;
        let scaledWidth = scaledHeight * photoAspectRatio;
        let padding = 1.5;
        let paddedWidth = scaledWidth * padding;
        let paddedHeight = scaledHeight * padding;
        let photoX = xPos + canvasWidth / 2 - paddedWidth / 2;
        let photoY = yPos + canvasHeight / 2 - paddedHeight / 2;
        return x >= photoX && x <= photoX + paddedWidth && y >= photoY && y <= photoY + paddedHeight;
      }
    }
    function isTouchOverCanvas(x, y) {
      const canvasContainer = document.getElementById('canvas-container');
      const rect = canvasContainer.getBoundingClientRect();
      return x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
    }
    function mousePressed() {
      if (photoLoaded && isTouchOverPhoto(mouseX, mouseY)) {
        isDragging = true;
        dragStartX = mouseX - xPos;
        dragStartY = mouseY - yPos;
      }
    }
    function mouseReleased() {
      isDragging = false;
    }
    function mouseDragged() {
      if (isDragging) {
        xPos = mouseX - dragStartX;
        yPos = mouseY - dragStartY;
        document.getElementById('xPos').value = xPos;
        document.getElementById('yPos').value = yPos;
      }
    }
    function touchStarted() {
      if (touches.length === 1) {
        let touchX = touches[0].x;
        let touchY = touches[0].y;
        if (isTouchOverCanvas(touchX, touchY) && photoLoaded && isTouchOverPhoto(touchX, touchY)) {
          isDragging = true;
          dragStartX = touchX - xPos;
          dragStartY = touchY - yPos;
          return false;
        }
      } else if (touches.length === 2) {
        let touch1X = touches[0].x;
        let touch1Y = touches[0].y;
        let touch2X = touches[1].x;
        let touch2Y = touches[1].y;
        let midX = (touch1X + touch2X) / 2;
        let midY = (touch1Y + touch2Y) / 2;
        if (isTouchOverCanvas(midX, midY) && photoLoaded && isTouchOverPhoto(midX, midY)) {
          isPinching = true;
          isDragging = false;
          initialPinchDistance = dist(touch1X, touch1Y, touch2X, touch2Y);
          initialScale = scaleVal;
          return false;
        }
      }
      return true;
    }
    function touchMoved() {
      if (touches.length === 1 && isDragging) {
        xPos = touches[0].x - dragStartX;
        yPos = touches[0].y - dragStartY;
        document.getElementById('xPos').value = xPos;
        document.getElementById('yPos').value = yPos;
        return false;
      } else if (touches.length === 2 && isPinching) {
        let currentDistance = dist(touches[0].x, touches[0].y, touches[1].x, touches[1].y);
        let scaleFactor = currentDistance / initialPinchDistance;
        scaleVal = constrain(initialScale * scaleFactor, 0.1, 2);
        document.getElementById('scale').value = scaleVal;
        return false;
      }
      return true;
    }
    function touchEnded() {
      isDragging = false;
      isPinching = false;
      return true;
    }
    function draw() {
      clear();
      if (templateLoaded && templateImg) {
        fill(0);
        noStroke();
        rect(0, 0, canvasWidth, canvasHeight);
        if (photoLoaded && photoImg && !photoInFront) {
          push();
          translate(xPos + canvasWidth / 2, yPos + canvasHeight / 2);
          rotate(radians(rotationVal));
          scale(scaleVal);
          imageMode(CENTER);
          let scaledHeight = photoImg.height * scaleVal;
          let scaledWidth = scaledHeight * photoAspectRatio;
          image(photoImg, 0, 0, scaledWidth, scaledHeight);
          pop();
        }
        imageMode(CORNER);
        image(templateImg, 0, 0, canvasWidth, canvasHeight);
        imageMode(CENTER);
        if (photoLoaded && photoImg && photoInFront) {
          push();
          translate(xPos + canvasWidth / 2, yPos + canvasHeight / 2);
          rotate(radians(rotationVal));
          scale(scaleVal);
          let scaledHeight = photoImg.height * scaleVal;
          let scaledWidth = scaledHeight * photoAspectRatio;
          image(photoImg, 0, 0, scaledWidth, scaledHeight);
          pop();
        }
        if (photoLoaded && (height || width)) {
          textFont('Orbitron', 'Arial');
          if (isPortrait && (height || width)) {
            textAlign(CENTER, TOP);
            fill(255);
            let combinedText = height && width ? `${height} ${width}` : height || width;
            let adjustedFontSize = adjustFontSizeForName(combinedText, heightFontSize * 2, maxNameWidth, true);
            textSize(adjustedFontSize);
            text(combinedText, canvasWidth / 2, 8.457);
          }
          textAlign(LEFT, TOP);
          if (height) {
            fill(0);
            let adjustedFontSize = adjustFontSizeForName(height, heightFontSize, maxNameWidth, true);
            textSize(adjustedFontSize);
            if (!isPortrait) {
              textStyle(BOLD);
            }
            text(height, heightPosX, heightPosY);
            if (!isPortrait) {
              textStyle(NORMAL);
            }
          }
          if (width) {
            fill(0);
            let adjustedFontSize = adjustFontSizeForName(width, heightFontSize, maxNameWidth);
            textSize(adjustedFontSize);
            textStyle(BOLD);
            text(width, widthPosX, widthPosY);
            textStyle(NORMAL);
          }
        }
      }
    }
    function validateFile(file, type) {
      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
      const maxSizeMB = 5;
      if (!allowedTypes.includes(file.type)) {
        return `Please upload a ${type.toLowerCase()} in JPEG, PNG, or GIF format.`;
      }
      if (file.size > maxSizeMB * 1024 * 1024) {
        return `The ${type.toLowerCase()} file exceeds the ${maxSizeMB}MB size limit. Please upload a smaller file.`;
      }
      return null;
    }
    document.addEventListener('DOMContentLoaded', () => {
      const templateUpload = document.getElementById('templateUpload');
      const photoUpload = document.getElementById('photoUpload');
      const heightInput = document.getElementById('height');
      const widthInput = document.getElementById('width');
      const xPosSlider = document.getElementById('xPos');
      const yPosSlider = document.getElementById('yPos');
      const scaleSlider = document.getElementById('scale');
      const rotationSlider = document.getElementById('rotation');
      const sendBackButton = document.getElementById('sendBack');
      const bringFrontButton = document.getElementById('bringFront');
      const downloadButton = document.getElementById('download');
      if (templateUpload) {
        templateUpload.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const validationError = validateFile(file, 'Template');
            if (validationError) {
              alert(validationError);
              templateUpload.value = '';
              return;
            }
            const url = URL.createObjectURL(file);
            loadingMessage.style.display = 'block';
            loadingMessage.textContent = 'Loading template...';
            try {
              loadImage(
                url,
                (img) => {
                  isPortrait = img.height > img.width;
                  if (isPortrait) {
                    canvasWidth = 387;
                    canvasHeight = 614;
                    document.querySelector('.main-container').classList.add('portrait');
                  } else {
                    canvasWidth = 491;
                    canvasHeight = 310;
                    document.querySelector('.main-container').classList.remove('portrait');
                  }
                  originalTemplateWidth = img.width;
                  originalTemplateHeight = img.height;
                  templateImg = img;
                  templateLoaded = true;
                  photoInFront = true;
                  updateCanvasSize();
                  loadingMessage.style.display = 'none';
                  document.getElementById('canvas-container').style.backgroundImage = 'none';
                  URL.revokeObjectURL(url);
                  templateUpload.value = '';
                },
                (err) => {
                  loadingMessage.textContent = 'Failed to load template';
                  setTimeout(() => {
                    loadingMessage.style.display = 'none';
                  }, 3000);
                  alert('Error loading template image: ' + (err.message || 'Unknown error') + '. Please try a different image.');
                  URL.revokeObjectURL(url);
                  templateUpload.value = '';
                }
              );
            } catch (err) {
              loadingMessage.textContent = 'Failed to load template';
              setTimeout(() => {
                loadingMessage.style.display = 'none';
              }, 3000);
              alert('Exception while loading template: ' + (err.message || 'Unknown error') + '. Please try a different image.');
              URL.revokeObjectURL(url);
              templateUpload.value = '';
            }
          }
        });
      }
      if (photoUpload) {
        photoUpload.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const validationError = validateFile(file, 'Photo');
            if (validationError) {
              alert(validationError);
              return;
            }
            const url = URL.createObjectURL(file);
            loadingMessage.style.display = 'block';
            loadingMessage.textContent = 'Loading photo...';
            try {
              loadImage(
                url,
                (img) => {
                  photoAspectRatio = img.width / img.height;
                  photoImg = img;
                  if (img.width > canvasWidth * 2 || img.height > canvasHeight * 2) {
                    scaleVal = 0.5;
                  } else {
                    scaleVal = 1.25;
                  }
                  document.getElementById('scale').value = scaleVal;
                  photoLoaded = true;
                  loadingMessage.style.display = 'none';
                  updateCanvasSize();
                  URL.revokeObjectURL(url);
                },
                (err) => {
                  loadingMessage.textContent = 'Failed to load photo';
                  setTimeout(() => {
                    loadingMessage.style.display = 'none';
                  }, 3000);
                  alert('Error loading photo image: ' + (err.message || 'Unknown error') + '. Please try a different image.');
                  URL.revokeObjectURL(url);
                }
              );
            } catch (err) {
              loadingMessage.textContent = 'Failed to load photo';
              setTimeout(() => {
                loadingMessage.style.display = 'none';
              }, 3000);
              alert('Exception while loading photo: ' + (err.message || 'Unknown error') + '. Please try a different image.');
              URL.revokeObjectURL(url);
            }
          }
        });
      }
      if (heightInput) {
        heightInput.addEventListener('input', (e) => {
          height = e.target.value;
        });
      }
      if (widthInput) {
        widthInput.addEventListener('input', (e) => {
          width = e.target.value;
        });
      }
      if (xPosSlider) {
        xPosSlider.addEventListener('input', (e) => {
          xPos = parseInt(e.target.value);
        });
      }
      if (yPosSlider) {
        yPosSlider.addEventListener('input', (e) => {
          yPos = parseInt(e.target.value);
        });
      }
      if (scaleSlider) {
        scaleSlider.addEventListener('input', (e) => {
          scaleVal = parseFloat(e.target.value);
        });
      }
      if (rotationSlider) {
        rotationSlider.addEventListener('input', (e) => {
          rotationVal = parseFloat(e.target.value);
        });
      }
      if (sendBackButton) {
        sendBackButton.addEventListener('click', () => {
          photoInFront = false;
        });
      }
      if (bringFrontButton) {
        bringFrontButton.addEventListener('click', () => {
          photoInFront = true;
        });
      }
      if (downloadButton) {
        downloadButton.addEventListener('click', () => {
          if (templateLoaded && photoLoaded && templateImg && photoImg) {
            const resolutionMultiplier = 2;
            let highResWidth = originalTemplateWidth * resolutionMultiplier;
            let highResHeight = originalTemplateHeight * resolutionMultiplier;
            let highResCanvas = createGraphics(highResWidth, highResHeight);
            if (templateLoaded) {
              highResCanvas.fill(0);
              highResCanvas.noStroke();
              highResCanvas.rect(0, 0, highResWidth, highResHeight);
            }
            if (!photoInFront) {
              highResCanvas.push();
              highResCanvas.translate((xPos + canvasWidth / 2) * (highResWidth / canvasWidth), (yPos + canvasHeight / 2) * (highResHeight / canvasHeight));
              highResCanvas.rotate(radians(rotationVal));
              highResCanvas.scale(scaleVal);
              highResCanvas.imageMode(CENTER);
              let scaledHeight = photoImg.height * scaleVal;
              let scaledWidth = scaledHeight * photoAspectRatio;
              highResCanvas.image(photoImg, 0, 0, scaledWidth * (highResWidth / canvasWidth), scaledHeight * (highResHeight / canvasHeight));
              highResCanvas.pop();
            }
            highResCanvas.imageMode(CORNER);
            highResCanvas.image(templateImg, 0, 0, highResWidth, highResHeight);
            highResCanvas.imageMode(CENTER);
            if (photoInFront) {
              highResCanvas.push();
              highResCanvas.translate((xPos + canvasWidth / 2) * (highResWidth / canvasWidth), (yPos + canvasHeight / 2) * (highResHeight / canvasHeight));
              highResCanvas.rotate(radians(rotationVal));
              highResCanvas.scale(scaleVal);
              let scaledHeight = photoImg.height * scaleVal;
              let scaledWidth = scaledHeight * photoAspectRatio;
              highResCanvas.image(photoImg, 0, 0, scaledWidth * (highResWidth / canvasWidth), scaledHeight * (highResHeight / canvasHeight));
              highResCanvas.pop();
            }
            if (height || width) {
              highResCanvas.textFont('Orbitron', 'Arial');
              if (isPortrait && (height || width)) {
                highResCanvas.textAlign(CENTER, TOP);
                highResCanvas.fill(255);
                let combinedText = height && width ? `${height} ${width}` : height || width;
                let adjustedFontSize = adjustFontSizeForName(combinedText, heightFontSize * 2, maxNameWidth, true);
                highResCanvas.textSize(adjustedFontSize * (highResWidth / canvasWidth));
                highResCanvas.text(combinedText, highResWidth / 2, 8.457 * (highResHeight / canvasHeight));
              }
              highResCanvas.textAlign(LEFT, TOP);
              if (height) {
                highResCanvas.fill(0);
                let adjustedFontSize = adjustFontSizeForName(height, heightFontSize, maxNameWidth, true);
                highResCanvas.textSize(adjustedFontSize * (highResWidth / canvasWidth));
                if (!isPortrait) {
                  highResCanvas.textStyle(BOLD);
                }
                highResCanvas.text(height, heightPosX * (highResWidth / canvasWidth), heightPosY * (highResHeight / canvasHeight));
                if (!isPortrait) {
                  highResCanvas.textStyle(NORMAL);
                }
              }
              if (width) {
                highResCanvas.fill(0);
                let adjustedFontSize = adjustFontSizeForName(width, heightFontSize, maxNameWidth);
                highResCanvas.textSize(adjustedFontSize * (highResWidth / canvasWidth));
                highResCanvas.textStyle(BOLD);
                highResCanvas.text(width, widthPosX * (highResWidth / canvasWidth), widthPosY * (highResHeight / canvasHeight));
                highResCanvas.textStyle(NORMAL);
              }
            }
            highResCanvas.canvas.toBlob((blob) => {
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = height ? `${height.replace(/[^a-zA-Z0-9]/g, '')}-AstroKidBadge.png` : 'AstroKidBadge.png';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
            }, 'image/png');
          } else {
            alert('Please upload both a template and a photo.');
          }
        });
      }
      window.addEventListener('resize', () => {
        updateCanvasSize();
      });
    });
  </script>
</body>
</html>
